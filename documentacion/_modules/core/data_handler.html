

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>core.data_handler &mdash; Flash Sheet - Exportación Separada 1.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=fc837d61"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Flash Sheet - Exportación Separada
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Developer Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/architecture.html">Sistema de Arquitectura - Flash Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide/contributing.html">Guía para Contribuidores - Exportación Separada</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/classes.html">API Reference - Classes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Flash Sheet - Exportación Separada</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">core.data_handler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for core.data_handler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Módulo para manejo de datos - carga, análisis y exportación</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="c1"># Añadir directorio raíz para importar config</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="n">optimization_config</span>


<div class="viewcode-block" id="cargar_datos">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.cargar_datos">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cargar_datos</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cargar datos desde un archivo usando el nuevo sistema de loaders</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath: Ruta del archivo a cargar</span>
<span class="sd">        chunk_size: Tamaño de chunk para lectura (si el formato lo soporta)</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame de Pandas con los datos cargados</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: Si el archivo no existe</span>
<span class="sd">        ValueError: Si el archivo no es soportado</span>
<span class="sd">        Exception: Para otros errores de carga</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">core.loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_file_loader</span>

    <span class="c1"># Usar el factory pattern para cargar el archivo</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">get_file_loader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    
    <span class="c1"># Aplicar optimización para archivos grandes</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">can_load_chunks</span><span class="p">()</span> <span class="ow">and</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_memory_usage_info</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Usar configuración de optimización</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_memory_usage_info</span><span class="p">()</span>
            <span class="n">estimated_rows</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estimated_data_rows&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">estimated_rows</span> <span class="o">&gt;</span> <span class="n">optimization_config</span><span class="o">.</span><span class="n">VIRTUALIZATION_THRESHOLD</span><span class="p">:</span>
                <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">10000</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_in_chunks</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Si falla el chunk loading, usar carga normal</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chunk loading falló, usando carga normal: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">cargar_datos_con_opciones</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">skip_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">column_names</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cargar datos desde un archivo con opciones adicionales usando el sistema de loaders</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath: Ruta del archivo a cargar</span>
<span class="sd">        skip_rows: Número de filas a saltar al inicio (la siguiente fila se usa como header)</span>
<span class="sd">        column_names: Diccionario con nombres de columnas a renombrar {original: nuevo}</span>
<span class="sd">        chunk_size: Tamaño de chunk para lectura (si el formato lo soporta)</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame de Pandas con los datos cargados y opciones aplicadas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">core.loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_file_loader</span>

    <span class="c1"># Usar el factory pattern para cargar el archivo</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">get_file_loader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    
    <span class="c1"># Aplicar optimización para archivos grandes</span>
    <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">can_load_chunks</span><span class="p">()</span> <span class="ow">and</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_memory_usage_info</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Usar configuración de optimización</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_memory_usage_info</span><span class="p">()</span>
            <span class="n">estimated_rows</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estimated_data_rows&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">estimated_rows</span> <span class="o">&gt;</span> <span class="n">optimization_config</span><span class="o">.</span><span class="n">VIRTUALIZATION_THRESHOLD</span><span class="p">:</span>
                <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">10000</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_in_chunks</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Si falla el chunk loading, usar carga normal</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chunk loading falló, usando carga normal: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">skip_rows</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Carga normal con opciones</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">skip_rows</span><span class="p">,</span> <span class="n">column_names</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_supported_file_formats</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get list of all supported file formats</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of supported file extensions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">core.loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_supported_formats</span>
    <span class="k">return</span> <span class="n">get_supported_formats</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">is_file_format_supported</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a file format is supported</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        filepath: Path to the file</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        True if the file format is supported</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">core.loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_file_supported</span>
    <span class="k">return</span> <span class="n">is_file_supported</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>


<div class="viewcode-block" id="obtener_metadata">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.obtener_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">obtener_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtener metadata del DataFrame</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame de Pandas</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Diccionario con información sobre los datos</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;filas&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;columnas&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;nombres_columnas&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;tipos_datos&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;columnas_numericas&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;columnas_texto&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;valores_nulos&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">metadata</span></div>



<div class="viewcode-block" id="obtener_estadisticas">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.obtener_estadisticas">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">obtener_estadisticas</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columnas</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtener estadísticas descriptivas del DataFrame con optimización para datasets grandes</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame de Pandas</span>
<span class="sd">        columnas: Lista de columnas específicas (si None, usar todas las numéricas)</span>
<span class="sd">        percentiles: Lista de percentiles a calcular (si None, usar [25, 50, 75])</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame con estadísticas descriptivas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># Si no se especifican columnas, usar solo las numéricas para optimizar</span>
        <span class="k">if</span> <span class="n">columnas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columnas</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">columnas</span><span class="p">:</span>
                <span class="c1"># Si no hay columnas numéricas, usar todas</span>
                <span class="n">columnas</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Configurar percentiles por defecto (convertir a decimales)</span>
        <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]</span>  <span class="c1"># Usar decimales en lugar de porcentajes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convertir percentiles de porcentaje a decimal si es necesario</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">/</span><span class="mi">100</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">]</span>

        <span class="c1"># Para datasets muy grandes, usar sample para estadísticas aproximadas</span>
        <span class="k">if</span> <span class="n">optimization_config</span><span class="o">.</span><span class="n">should_sample_stats</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset grande detectado (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> filas), calculando estadísticas con sample...&quot;</span><span class="p">)</span>
            <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">optimization_config</span><span class="o">.</span><span class="n">STATS_SAMPLE_SIZE</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
            <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># Calcular estadísticas solo para las columnas especificadas</span>
        <span class="n">estadisticas</span> <span class="o">=</span> <span class="n">df_sample</span><span class="p">[</span><span class="n">columnas</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">percentiles</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">estadisticas</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al calcular estadísticas: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Si hay error, devolver DataFrame vacío</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">obtener_estadisticas_basicas</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtener estadísticas básicas optimizadas para datasets grandes</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame de Pandas</span>

<span class="sd">    Returns:</span>
<span class="sd">        Diccionario con estadísticas básicas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">basic_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;total_filas&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="s1">&#39;total_columnas&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
            <span class="s1">&#39;columnas_numericas&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
            <span class="s1">&#39;columnas_texto&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
            <span class="s1">&#39;columnas_fecha&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
            <span class="s1">&#39;memoria_uso_mb&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
            <span class="s1">&#39;filas_duplicadas&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="s1">&#39;valores_nulos_total&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">basic_stats</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al calcular estadísticas básicas: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>


<div class="viewcode-block" id="aplicar_filtro">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.aplicar_filtro">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">aplicar_filtro</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columna</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">termino</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aplicar filtro a los datos con optimización para datasets grandes</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame original</span>
<span class="sd">        columna: Nombre de la columna a filtrar</span>
<span class="sd">        termino: Término de búsqueda</span>
<span class="sd">        use_index: Usar búsqueda indexada para mejor rendimiento</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame filtrado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">columna</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columna no encontrada: </span><span class="si">{</span><span class="n">columna</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Para datasets muy grandes, usar optimizaciones</span>
    <span class="k">if</span> <span class="n">optimization_config</span><span class="o">.</span><span class="n">should_optimize_filtering</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="ow">and</span> <span class="n">use_index</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_aplicar_filtro_indexado</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columna</span><span class="p">,</span> <span class="n">termino</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_aplicar_filtro_simple</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columna</span><span class="p">,</span> <span class="n">termino</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_aplicar_filtro_simple</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columna</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">termino</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aplicar filtro simple (método original)</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame original</span>
<span class="sd">        columna: Nombre de la columna a filtrar</span>
<span class="sd">        termino: Término de búsqueda</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame filtrado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filtrar por contenido de texto (case-insensitive)</span>
    <span class="n">df_filtrado</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">termino</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">df_filtrado</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_aplicar_filtro_indexado</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columna</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">termino</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aplicar filtro optimizado usando indexación para datasets grandes</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame original</span>
<span class="sd">        columna: Nombre de la columna a filtrar</span>
<span class="sd">        termino: Término de búsqueda</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame filtrado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Convertir columna a string para búsqueda de texto</span>
        <span class="n">columna_str</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># Crear una serie booleana para el filtro</span>
        <span class="k">if</span> <span class="n">termino</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">termino</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">):</span>
            <span class="c1"># Búsqueda exacta (regex)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">termino</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">columna_str</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">termino</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">termino</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
            <span class="c1"># Búsqueda con wildcards</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">termino</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">columna_str</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Búsqueda normal</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">columna_str</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">termino</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Aplicar filtro</span>
        <span class="n">df_filtrado</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtro aplicado: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_filtrado</span><span class="p">)</span><span class="si">}</span><span class="s2"> de </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> filas encontradas&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_filtrado</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en filtrado indexado, usando método simple: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_aplicar_filtro_simple</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columna</span><span class="p">,</span> <span class="n">termino</span><span class="p">)</span>


<div class="viewcode-block" id="exportar_a_pdf">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.exportar_a_pdf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">exportar_a_pdf</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exportar DataFrame a archivo PDF</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame a exportar</span>
<span class="sd">        filepath: Ruta de destino</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        True si la exportación fue exitosa</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib.pagesizes</span><span class="w"> </span><span class="kn">import</span> <span class="n">letter</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.platypus</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleDocTemplate</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">TableStyle</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span>
        
        <span class="c1"># Crear documento</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">SimpleDocTemplate</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="n">letter</span><span class="p">)</span>
        
        <span class="c1"># Convertir DataFrame a lista de listas</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="c1"># Crear tabla</span>
        <span class="n">tabla</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">estilo</span> <span class="o">=</span> <span class="n">TableStyle</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">grey</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TEXTCOLOR&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">whitesmoke</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Helvetica-Bold&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTSIZE&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">12</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">beige</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">.</span><span class="n">black</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">tabla</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">estilo</span><span class="p">)</span>
        
        <span class="c1"># Construir documento</span>
        <span class="n">doc</span><span class="o">.</span><span class="n">build</span><span class="p">([</span><span class="n">tabla</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al exportar a PDF: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="exportar_a_sql">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.exportar_a_sql">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">exportar_a_sql</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nombre_tabla</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exportar DataFrame a base de datos SQL</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame a exportar</span>
<span class="sd">        filepath: Ruta de la base de datos</span>
<span class="sd">        nombre_tabla: Nombre de la tabla en la base de datos</span>

<span class="sd">    Returns:</span>
<span class="sd">        True si la exportación fue exitosa</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>

        <span class="c1"># Crear engine para SQLite</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sqlite:///</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Exportar a SQL</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">nombre_tabla</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al exportar a SQL: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="exportar_a_imagen">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.exportar_a_imagen">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">exportar_a_imagen</span><span class="p">(</span><span class="n">table_view</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exportar vista de tabla a imagen</span>

<span class="sd">    Args:</span>
<span class="sd">        table_view: QTableView a capturar</span>
<span class="sd">        filepath: Ruta de destino para la imagen</span>

<span class="sd">    Returns:</span>
<span class="sd">        True si la exportación fue exitosa</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PySide6.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">QApplication</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PySide6.QtGui</span><span class="w"> </span><span class="kn">import</span> <span class="n">QPixmap</span>

        <span class="c1"># Capturar la vista de la tabla como pixmap</span>
        <span class="n">pixmap</span> <span class="o">=</span> <span class="n">table_view</span><span class="o">.</span><span class="n">grab</span><span class="p">()</span>

        <span class="c1"># Guardar como imagen (PNG por defecto)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al guardar la imagen en </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al exportar a imagen: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">exportar_a_xlsx</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exportar DataFrame a archivo Excel (.xlsx)</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame a exportar</span>
<span class="sd">        filepath: Ruta de destino</span>

<span class="sd">    Returns:</span>
<span class="sd">        True si la exportación fue exitosa</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Verificar que openpyxl esté disponible</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">openpyxl</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">openpyxl.utils.dataframe</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataframe_to_rows</span>

        <span class="c1"># Crear workbook y worksheet</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span><span class="p">()</span>
        <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">active</span>

        <span class="c1"># Convertir DataFrame a filas y escribir en worksheet</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataframe_to_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Guardar archivo</span>
        <span class="n">workbook</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: openpyxl no está instalado. Instale con: pip install openpyxl&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al exportar a XLSX: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">exportar_a_csv</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exportar DataFrame a archivo CSV</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame a exportar</span>
<span class="sd">        filepath: Ruta de destino</span>
<span class="sd">        delimiter: Delimitador para CSV (default: &#39;,&#39;)</span>
<span class="sd">        encoding: Codificación del archivo (default: &#39;utf-8&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        True si la exportación fue exitosa</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Exportar a CSV usando pandas</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al exportar a CSV: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="limpiar_datos">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.limpiar_datos">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">limpiar_datos</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">opciones</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limpiar datos del DataFrame aplicando varias operaciones de limpieza</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame original</span>
<span class="sd">        opciones: Diccionario con opciones de limpieza</span>
<span class="sd">            - eliminar_duplicados: bool (default True)</span>
<span class="sd">            - eliminar_nulos: bool (default False)</span>
<span class="sd">            - rellenar_nulos: dict con columna: valor para rellenar</span>
<span class="sd">            - eliminar_columnas: list de columnas a eliminar</span>
<span class="sd">            - convertir_tipos: dict con columna: tipo</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame limpio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">opciones</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">opciones</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Eliminar duplicados</span>
    <span class="k">if</span> <span class="n">opciones</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eliminar_duplicados&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># Eliminar filas con nulos si se especifica</span>
    <span class="k">if</span> <span class="n">opciones</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eliminar_nulos&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># Rellenar nulos con valores especificados</span>
    <span class="n">rellenar_nulos</span> <span class="o">=</span> <span class="n">opciones</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rellenar_nulos&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">columna</span><span class="p">,</span> <span class="n">valor</span> <span class="ow">in</span> <span class="n">rellenar_nulos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">columna</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_clean</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">valor</span><span class="p">)</span>

    <span class="c1"># Eliminar columnas especificadas</span>
    <span class="n">eliminar_columnas</span> <span class="o">=</span> <span class="n">opciones</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eliminar_columnas&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">for</span> <span class="n">columna</span> <span class="ow">in</span> <span class="n">eliminar_columnas</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">columna</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">columna</span><span class="p">])</span>

    <span class="c1"># Convertir tipos de datos</span>
    <span class="n">convertir_tipos</span> <span class="o">=</span> <span class="n">opciones</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;convertir_tipos&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">columna</span><span class="p">,</span> <span class="n">tipo</span> <span class="ow">in</span> <span class="n">convertir_tipos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">columna</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;numeric&#39;</span><span class="p">:</span>
                    <span class="n">df_clean</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">columna</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span><span class="p">:</span>
                    <span class="n">df_clean</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">columna</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tipo</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">:</span>
                    <span class="n">df_clean</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al convertir tipo de </span><span class="si">{</span><span class="n">columna</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_clean</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">agregar_datos</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">operaciones</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realizar operaciones de agregación en el DataFrame</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame original</span>
<span class="sd">        operaciones: Lista de diccionarios con operaciones</span>
<span class="sd">            Cada operación: {</span>
<span class="sd">                &#39;grupo&#39;: [&#39;col1&#39;, &#39;col2&#39;],  # Columnas para agrupar</span>
<span class="sd">                &#39;funciones&#39;: {&#39;col3&#39;: &#39;sum&#39;, &#39;col4&#39;: [&#39;mean&#39;, &#39;count&#39;]},</span>
<span class="sd">                &#39;nombre&#39;: &#39;resultado&#39;  # Nombre para el resultado</span>
<span class="sd">            }</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame con resultados de agregación</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">operaciones</span><span class="p">:</span>
        <span class="n">grupo</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grupo&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">funciones</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;funciones&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">nombre</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nombre&#39;</span><span class="p">,</span> <span class="s1">&#39;agregado&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grupo</span><span class="p">:</span>
                <span class="c1"># Agregación por grupos</span>
                <span class="n">df_agregado</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grupo</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">funciones</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Agregación global</span>
                <span class="n">df_agregado</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">funciones</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Aplanar columnas si hay múltiples funciones</span>
            <span class="n">df_agregado</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="n">col</span>
                                   <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_agregado</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

            <span class="n">df_agregado</span><span class="p">[</span><span class="s1">&#39;operacion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nombre</span>
            <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_agregado</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en agregación &#39;</span><span class="si">{</span><span class="n">nombre</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">resultados</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">resultados</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">pivotar_datos</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">aggfunc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crear tabla pivote del DataFrame</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame original</span>
<span class="sd">        index: Columna para usar como índice</span>
<span class="sd">        columns: Columna para usar como columnas</span>
<span class="sd">        values: Columna para usar como valores</span>
<span class="sd">        aggfunc: Función de agregación (mean, sum, count, etc.)</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame pivoteado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">aggfunc</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span>
        <span class="k">elif</span> <span class="n">aggfunc</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span>
        <span class="k">elif</span> <span class="n">aggfunc</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">aggfunc</span>

        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error al crear tabla pivote: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>




<span class="c1"># ===============================</span>
<span class="c1"># SISTEMA DE EXPORTACIÓN SEPARADA CON PLANTILLAS EXCEL (FASE 3)</span>
<span class="c1"># ===============================</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">openpyxl</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">openpyxl</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_workbook</span><span class="p">,</span> <span class="n">Workbook</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">openpyxl.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_column_letter</span><span class="p">,</span> <span class="n">column_index_from_string</span><span class="p">,</span> <span class="n">coordinate_to_tuple</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">openpyxl.styles</span><span class="w"> </span><span class="kn">import</span> <span class="n">Font</span><span class="p">,</span> <span class="n">PatternFill</span><span class="p">,</span> <span class="n">Border</span><span class="p">,</span> <span class="n">Alignment</span>
    <span class="n">OPENPYXL_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">OPENPYXL_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Importar optimizaciones de rendimiento</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">core.performance_optimizer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">PerformanceOptimizer</span><span class="p">,</span> <span class="n">ExcelFormatOptimizer</span><span class="p">,</span> <span class="n">ProgressMonitor</span><span class="p">,</span>
        <span class="n">ChunkingStrategy</span><span class="p">,</span> <span class="n">SystemResources</span><span class="p">,</span> <span class="n">PerformanceConfig</span><span class="p">,</span>
        <span class="n">PerformanceResult</span><span class="p">,</span> <span class="n">ProgressInfo</span>
    <span class="p">)</span>
    <span class="n">PERFORMANCE_OPTIMIZER_AVAILABLE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">PERFORMANCE_OPTIMIZER_AVAILABLE</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Clases fallback si no está disponible el optimizador</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">ChunkingStrategy</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">NONE</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
        <span class="n">MODERATE</span> <span class="o">=</span> <span class="s2">&quot;moderate&quot;</span>
        <span class="n">SIZE_BASED</span> <span class="o">=</span> <span class="s2">&quot;size&quot;</span>
        <span class="n">GROUP_BASED</span> <span class="o">=</span> <span class="s2">&quot;group&quot;</span>
        <span class="n">AGGRESSIVE</span> <span class="o">=</span> <span class="s2">&quot;aggressive&quot;</span>
    
    <span class="k">class</span><span class="w"> </span><span class="nc">SystemResources</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_usage_mb</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_percent</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disk_free_gb</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="k">class</span><span class="w"> </span><span class="nc">PerformanceConfig</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_threshold_mb</span> <span class="o">=</span> <span class="mi">2048</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_operations</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_interval</span> <span class="o">=</span> <span class="mi">10</span>


<div class="viewcode-block" id="ExportSeparatedConfig">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExportSeparatedConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ExportSeparatedConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuración completa para separación de datos&quot;&quot;&quot;</span>
    
    <span class="c1"># Datos de origen - Argumentos requeridos primero</span>
    <span class="n">separator_column</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Columna para separar</span>
    <span class="n">template_path</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Ruta a plantilla .xlsx</span>
    <span class="n">output_folder</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Carpeta destino</span>
    
    <span class="c1"># Argumentos opcionales con valores por defecto</span>
    <span class="n">start_cell</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;A1&quot;</span>  <span class="c1"># Celda inicial para datos</span>
    <span class="n">file_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{valor}</span><span class="s2">.xlsx&quot;</span>  <span class="c1"># Plantilla nombre archivo</span>
    
    <span class="c1"># Mapeo de columnas</span>
    <span class="n">column_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># Ej: {&#39;columna_df&#39;: &#39;A&#39;, &#39;otra_columna&#39;: &#39;C&#39;}</span>
    
    <span class="c1"># Opciones avanzadas</span>
    <span class="n">handle_duplicates</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;overwrite&quot;</span>  <span class="c1"># &#39;overwrite&#39;, &#39;append&#39;, &#39;skip&#39;</span>
    <span class="n">create_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Crear archivo resumen</span>
    <span class="n">preserve_format</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Preservar formato Excel</span>
    
    <span class="c1"># Opciones de rendimiento</span>
    <span class="n">enable_chunking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Habilitar chunking automático</span>
    <span class="n">max_memory_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span>  <span class="c1"># Límite de memoria</span>
    <span class="n">progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Callback de progreso</span>
    
<div class="viewcode-block" id="ExportSeparatedConfig.validate">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExportSeparatedConfig.validate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validar configuración completa&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Validar columna de separación</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator_column</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Columna de separación es requerida&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validar plantilla Excel</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template_path</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plantilla no encontrada: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">template_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;.xlsm&#39;</span><span class="p">)):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Plantilla debe ser archivo .xlsx o .xlsm&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validar carpeta destino</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sin permisos de escritura en: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en carpeta destino: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validar celda inicial</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coordinate_to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_cell</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Celda inicial inválida: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_cell</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validar plantilla de nombre</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_template</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Plantilla de nombre de archivo es requerida&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_template</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Plantilla de nombre no tiene extensión .xlsx&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">errors</span><span class="p">,</span>
            <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="n">warnings</span>
        <span class="p">}</span></div>

    
<div class="viewcode-block" id="ExportSeparatedConfig.get_default_mapping">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExportSeparatedConfig.get_default_mapping">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtener mapeo por defecto (posicional)&quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">:</span>  <span class="c1"># A-Z</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_column_letter</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># AA, AB, etc.</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_column_letter</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mapping</span></div>
</div>



<div class="viewcode-block" id="ValidationResult">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ValidationResult">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ValidationResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resultado de validación&quot;&quot;&quot;</span>
    <span class="n">is_valid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">warnings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">info</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    
<div class="viewcode-block" id="ValidationResult.add_error">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ValidationResult.add_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="ValidationResult.add_warning">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ValidationResult.add_warning">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warning</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ValidationResult.add_info">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ValidationResult.add_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ExportResult">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExportResult">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ExportResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resultado de exportación individual&quot;&quot;&quot;</span>
    <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">rows_processed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">processing_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="SeparationError">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.SeparationError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SeparationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error base para separación de datos&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">details</span> <span class="ow">or</span> <span class="p">{}</span></div>



<div class="viewcode-block" id="TemplateError">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.TemplateError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TemplateError</span><span class="p">(</span><span class="n">SeparationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error específico de plantilla Excel&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ConfigurationError">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ConfigurationError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ConfigurationError</span><span class="p">(</span><span class="n">SeparationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error de configuración inválida&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="MemoryError">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.MemoryError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MemoryError</span><span class="p">(</span><span class="n">SeparationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error de memoria insuficiente&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ExcelTemplateSplitter">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExcelTemplateSplitter">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ExcelTemplateSplitter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clase principal para separación de datos con plantillas Excel&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="ExcelTemplateSplitter.__init__">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExcelTemplateSplitter.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">ExportSeparatedConfig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializar separador con DataFrame y configuración</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            df: DataFrame a separar</span>
<span class="sd">            config: Configuración de separación</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">progress_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancelled</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Verificar dependencias</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">OPENPYXL_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;openpyxl es requerido para separación con plantillas Excel&quot;</span><span class="p">)</span>
        
        <span class="c1"># Configurar optimizaciones de rendimiento</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_performance_optimization</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configurar logging consistente con sistema existente&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logger</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_performance_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configurar optimizaciones de rendimiento avanzadas&quot;&quot;&quot;</span>
        <span class="c1"># Inicializar optimizador de rendimiento si está disponible</span>
        <span class="k">if</span> <span class="n">PERFORMANCE_OPTIMIZER_AVAILABLE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_chunking</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">performance_optimizer</span> <span class="o">=</span> <span class="n">PerformanceOptimizer</span><span class="p">(</span>
                <span class="n">memory_threshold_mb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_memory_mb</span>
            <span class="p">)</span>
            
            <span class="c1"># Determinar estrategia de chunking óptima</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunking_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance_optimizer</span><span class="o">.</span><span class="n">determine_optimal_chunking_strategy</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span>
            <span class="p">)</span>
            
            <span class="c1"># Configurar optimizador de formato Excel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">excel_optimizer</span> <span class="o">=</span> <span class="n">ExcelFormatOptimizer</span><span class="p">()</span>
            
            <span class="c1"># Configurar monitor de progreso</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_monitor</span> <span class="o">=</span> <span class="n">ProgressMonitor</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">using_advanced_optimization</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback a optimización básica</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">performance_optimizer</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">excel_optimizer</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_monitor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">using_advanced_optimization</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1"># Usar optimización_config para determinar chunking básico</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">optimization_config</span><span class="o">.</span><span class="n">VIRTUALIZATION_THRESHOLD</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_memory_mb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enable_chunking</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">optimization_config</span><span class="o">.</span><span class="n">DEFAULT_CHUNK_SIZE</span><span class="p">,</span>
                    <span class="nb">max</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span> <span class="o">//</span> <span class="mi">20</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enable_chunking</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
    
<div class="viewcode-block" id="ExcelTemplateSplitter.validate_configuration">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExcelTemplateSplitter.validate_configuration">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidationResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validar configuración completa antes de proceder&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="p">()</span>
        
        <span class="c1"># Validación básica de configuración</span>
        <span class="n">config_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_validation</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">config_validation</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">config_validation</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        
        <span class="c1"># Validación de datos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s2">&quot;DataFrame está vacío&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columna &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span><span class="si">}</span><span class="s2">&#39; no existe en DataFrame&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="c1"># Validar valores únicos en columna de separación</span>
        <span class="n">unique_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="n">null_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">unique_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s2">&quot;No se encontraron valores únicos en columna de separación&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">unique_values</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">null_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s2">&quot;No hay datos para separar&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validación de plantilla Excel</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">template_path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">workbook</span> <span class="o">=</span> <span class="n">load_workbook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">template_path</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plantilla validada: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">template_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error validando plantilla Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>

    
<div class="viewcode-block" id="ExcelTemplateSplitter.analyze_data">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExcelTemplateSplitter.analyze_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analizar DataFrame para generar preview y validar separación&quot;&quot;&quot;</span>
        <span class="n">analysis</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Análisis básico</span>
        <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;total_columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;memory_usage_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span>
        
        <span class="c1"># Análisis de columna de separación</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">separator_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span><span class="p">]</span>
            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;separator_column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span>
            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;unique_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">separator_series</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;null_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">separator_series</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;null_percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;null_count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">separator_series</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
            
            <span class="c1"># Top valores más frecuentes</span>
            <span class="n">value_counts</span> <span class="o">=</span> <span class="n">separator_series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;top_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_counts</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;estimated_groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;unique_values&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;null_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Estimación de rendimiento</span>
        <span class="n">total_mb</span> <span class="o">=</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;memory_usage_mb&#39;</span><span class="p">]</span>
        <span class="n">estimated_processing_time</span> <span class="o">=</span> <span class="n">total_mb</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># 0.5 segundos por MB (estimado)</span>
        <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;estimated_processing_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimated_processing_time</span>
        <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;recommended_chunking&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">total_mb</span> <span class="o">&gt;</span> <span class="mi">500</span> <span class="ow">or</span>
            <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;estimated_groups&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_chunking</span>
        <span class="p">)</span>
        
        <span class="c1"># Recomendaciones</span>
        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;null_percentage&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Alto porcentaje de nulos detectado - considerar limpieza de datos&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;estimated_groups&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Muchos grupos detectados - usar chunking para mejor rendimiento&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_mb</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Dataset grande - habilitar chunking agresivo&quot;</span><span class="p">)</span>
        
        <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span>
        
        <span class="k">return</span> <span class="n">analysis</span></div>

    
<div class="viewcode-block" id="ExcelTemplateSplitter.generate_file_preview">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExcelTemplateSplitter.generate_file_preview">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_file_preview</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generar preview de archivos que se crearán&quot;&quot;&quot;</span>
        <span class="n">preview</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Obtener grupos únicos</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_df</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="c1"># Generar nombre de archivo</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_filename_for_group</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">))</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                
                <span class="c1"># Estimar tamaño de archivo (aproximado)</span>
                <span class="n">estimated_size_kb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># ~0.5KB por fila (estimado)</span>
                
                <span class="n">preview</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="s1">&#39;group_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">),</span>
                    <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">),</span>
                    <span class="s1">&#39;estimated_size_kb&#39;</span><span class="p">:</span> <span class="n">estimated_size_kb</span><span class="p">,</span>
                    <span class="s1">&#39;file_path&#39;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;ready&#39;</span>
                <span class="p">})</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generando preview: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="k">return</span> <span class="n">preview</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_filename_for_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">row_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generar nombre de archivo para un grupo específico&quot;&quot;&quot;</span>
        <span class="n">group_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;valor&#39;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
            <span class="s1">&#39;columna&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span><span class="p">,</span>
            <span class="s1">&#39;fecha&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="s1">&#39;fecha_hora&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H%M&#39;</span><span class="p">),</span>
            <span class="s1">&#39;filas&#39;</span><span class="p">:</span> <span class="n">row_count</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_file_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">file_template</span><span class="p">,</span> <span class="n">group_info</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_file_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">group_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Procesar plantilla de nombre de archivo con placeholders&quot;&quot;&quot;</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="n">template</span>
        
        <span class="c1"># Placeholders soportados</span>
        <span class="n">placeholders</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;</span><span class="si">{valor}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;valor&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;</span><span class="si">{columna}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;columna&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;</span><span class="si">{fecha}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fecha&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;</span><span class="si">{fecha_hora}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fecha_hora&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;</span><span class="si">{filas}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filas&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;</span><span class="si">{timestamp}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="p">}</span>
        
        <span class="c1"># Reemplazar placeholders</span>
        <span class="k">for</span> <span class="n">placeholder</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">placeholders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="n">processed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">placeholder</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Sanitizar nombre de archivo</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_filename</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_sanitize_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanitizar nombre para compatibilidad del SO&quot;&quot;&quot;</span>
        <span class="c1"># Caracteres prohibidos</span>
        <span class="n">forbidden_chars</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[&lt;&gt;:&quot;/</span><span class="se">\\</span><span class="s1">|?*]&#39;</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">forbidden_chars</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        
        <span class="c1"># Remover puntos múltiples al final</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.+$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sanitized</span><span class="p">)</span>
        
        <span class="c1"># Normalizar espacios</span>
        <span class="n">sanitized</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sanitized</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        
        <span class="c1"># Asegurar que no esté vacío</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sanitized</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">sanitized</span> <span class="o">=</span> <span class="s1">&#39;archivo_sin_nombre.xlsx&#39;</span>
        
        <span class="c1"># Límite de longitud</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">name_part</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">sanitized</span><span class="p">)</span>
            <span class="n">available_length</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="n">sanitized</span> <span class="o">=</span> <span class="n">name_part</span><span class="p">[:</span><span class="n">available_length</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="o">+</span> <span class="n">ext</span>
        
        <span class="k">return</span> <span class="n">sanitized</span>
    
<div class="viewcode-block" id="ExcelTemplateSplitter.separate_and_export">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExcelTemplateSplitter.separate_and_export">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">separate_and_export</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ejecutar separación completa y exportación&quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 1. Validar configuración</span>
            <span class="n">validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_configuration</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Configuración inválida: &#39;</span> <span class="o">+</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validation</span><span class="o">.</span><span class="n">errors</span><span class="p">),</span>
                    <span class="s1">&#39;validation_errors&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
                    <span class="s1">&#39;validation_warnings&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="o">.</span><span class="n">warnings</span>
                <span class="p">}</span>
            
            <span class="c1"># 2. Analizar datos</span>
            <span class="n">analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_data</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;estimated_groups&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No hay grupos para separar&#39;</span>
                <span class="p">}</span>
            
            <span class="c1"># 3. Procesar separación</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">groups_processed</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">group_df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">separator_column</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Verificar cancelación</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_cancelled&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancelled</span><span class="p">:</span>
                        <span class="k">break</span>
                    
                    <span class="c1"># Procesar grupo individual</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">),</span> <span class="n">group_df</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    
                    <span class="n">groups_processed</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="c1"># Callback de progreso</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="n">groups_processed</span><span class="p">,</span> <span class="n">analysis</span><span class="p">[</span><span class="s1">&#39;estimated_groups&#39;</span><span class="p">])</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error procesando grupo </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">error_result</span> <span class="o">=</span> <span class="n">ExportResult</span><span class="p">(</span>
                        <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">group_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">),</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failed_groups</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            
            <span class="c1"># 4. Generar resumen</span>
            <span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">successful_exports</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">success</span><span class="p">]</span>
            <span class="n">failed_exports</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">success</span><span class="p">]</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_exports</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;files_created&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">file_path</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">successful_exports</span><span class="p">],</span>
                <span class="s1">&#39;groups_processed&#39;</span><span class="p">:</span> <span class="n">groups_processed</span><span class="p">,</span>
                <span class="s1">&#39;total_rows&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;successful_exports&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_exports</span><span class="p">),</span>
                <span class="s1">&#39;failed_exports&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_exports</span><span class="p">),</span>
                <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="n">processing_time</span><span class="p">,</span>
                <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
                <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="n">validation</span><span class="o">.</span><span class="n">warnings</span><span class="p">,</span>
                <span class="s1">&#39;failed_groups&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_groups</span><span class="p">,</span>
                <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="n">analysis</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error crítico en separación: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="p">}</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_export_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">group_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExportResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exportar un grupo individual&quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ExportResult</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span>
        <span class="n">result</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Generar nombre de archivo</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_filename_for_group</span><span class="p">(</span><span class="n">group_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">))</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            
            <span class="c1"># Verificar conflictos de nombres</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_filename_conflicts</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="c1"># Crear archivo Excel con plantilla</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_excel_file_with_template</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">group_df</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
                <span class="n">result</span><span class="o">.</span><span class="n">rows_processed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_df</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">created_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Error creando archivo Excel&quot;</span>
            
            <span class="k">return</span> <span class="n">result</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="k">return</span> <span class="n">result</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_excel_file_with_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Crear archivo Excel usando plantilla preservando formato&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Usar preserver simple que evita problemas de recursión</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">core.simple_excel_preserver</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_excel_with_simple_format_preservation</span>
            
            <span class="c1"># Aplicar mapeo de columnas</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">column_mapping</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">column_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_default_mapping</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            
            <span class="c1"># Convertir DataFrame a dict para el preserver</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">row_offset</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">row_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">row_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            
            <span class="c1"># Crear archivo con preservación de formato</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">create_excel_with_simple_format_preservation</span><span class="p">(</span>
                <span class="n">template_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">template_path</span><span class="p">,</span>
                <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data_dict</span><span class="p">,</span>
                <span class="n">column_mapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">column_mapping</span><span class="p">,</span>
                <span class="n">start_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">start_cell</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Archivo Excel creado con formato preservado: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">success</span>
            
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="c1"># Fallback al método original si el preserver no está disponible</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;SimpleExcelPreserver no disponible, usando método original&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_excel_file_with_template_fallback</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creando archivo Excel con formato preservado: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_excel_file_with_template_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Método fallback para crear archivo Excel sin preserver de formato&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Cargar plantilla</span>
            <span class="n">workbook</span> <span class="o">=</span> <span class="n">load_workbook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">template_path</span><span class="p">,</span> <span class="n">data_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">active</span>
            
            <span class="c1"># Determinar posición inicial</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">openpyxl.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">coordinate_to_tuple</span><span class="p">,</span> <span class="n">column_index_from_string</span>
            <span class="n">start_row</span><span class="p">,</span> <span class="n">start_col</span> <span class="o">=</span> <span class="n">coordinate_to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">start_cell</span><span class="p">)</span>
            
            <span class="c1"># Aplicar mapeo de columnas</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">column_mapping</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">column_mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_default_mapping</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            
            <span class="c1"># Insertar datos MINIMALISTA para preservar formato</span>
            <span class="k">for</span> <span class="n">row_offset</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">row_data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
                <span class="n">excel_row</span> <span class="o">=</span> <span class="n">start_row</span> <span class="o">+</span> <span class="n">row_offset</span>
                
                <span class="k">for</span> <span class="n">df_col</span><span class="p">,</span> <span class="n">excel_col_letter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">column_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">df_col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">excel_col_idx</span> <span class="o">=</span> <span class="n">column_index_from_string</span><span class="p">(</span><span class="n">excel_col_letter</span><span class="p">)</span>
                        <span class="n">cell</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">excel_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">excel_col_idx</span><span class="p">)</span>
                        
                        <span class="c1"># Solo cambiar el VALOR, no tocar otros atributos</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">row_data</span><span class="p">[</span><span class="n">df_col</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                            <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
            
            <span class="c1"># Guardar archivo</span>
            <span class="n">workbook</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en método fallback creando archivo Excel: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_filename_conflicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolver conflictos de nombres de archivo&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">file_path</span>
        
        <span class="c1"># Auto-numeración</span>
        <span class="n">name_part</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_part</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">:</span><span class="s2">02d</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_path</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">new_path</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Límite de seguridad</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">999</span><span class="p">:</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_part</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
    
<div class="viewcode-block" id="ExcelTemplateSplitter.cancel_operation">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExcelTemplateSplitter.cancel_operation">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cancel_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancelar operación en curso&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cancelled</span> <span class="o">=</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="ExcelTemplateSplitter.cleanup_temp_files">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.ExcelTemplateSplitter.cleanup_temp_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_temp_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Limpiar archivos temporales en caso de cancelación&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No se pudo limpiar archivo temporal </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="exportar_datos_separados">
<a class="viewcode-back" href="../../api/classes.html#core.data_handler.exportar_datos_separados">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">exportar_datos_separados</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exportar DataFrame a archivos Excel separados usando plantillas</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame a separar</span>
<span class="sd">        config_dict: Configuración de separación</span>
<span class="sd">            - separator_column: str</span>
<span class="sd">            - template_path: str</span>
<span class="sd">            - start_cell: str (ej: &#39;A5&#39;)</span>
<span class="sd">            - output_folder: str</span>
<span class="sd">            - file_template: str</span>
<span class="sd">            - column_mapping: Dict[str, str]</span>
<span class="sd">            - handle_duplicates: str (&#39;overwrite&#39;, &#39;append&#39;, &#39;skip&#39;)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict con resultado:</span>
<span class="sd">            - success: bool</span>
<span class="sd">            - files_created: List[str]</span>
<span class="sd">            - groups_processed: int</span>
<span class="sd">            - total_rows: int</span>
<span class="sd">            - processing_time: float</span>
<span class="sd">            - errors: List[str]</span>
<span class="sd">            - warnings: List[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Crear configuración</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ExportSeparatedConfig</span><span class="p">(</span>
            <span class="n">separator_column</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;separator_column&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">template_path</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;template_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">start_cell</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_cell&#39;</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">),</span>
            <span class="n">output_folder</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_folder&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">file_template</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_template&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{valor}</span><span class="s1">.xlsx&#39;</span><span class="p">),</span>
            <span class="n">column_mapping</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_mapping&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">handle_duplicates</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;handle_duplicates&#39;</span><span class="p">,</span> <span class="s1">&#39;overwrite&#39;</span><span class="p">),</span>
            <span class="n">create_summary</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;create_summary&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">preserve_format</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preserve_format&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">enable_chunking</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enable_chunking&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">max_memory_mb</span><span class="o">=</span><span class="n">config_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_memory_mb&#39;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Crear splitter y ejecutar</span>
        <span class="n">splitter</span> <span class="o">=</span> <span class="n">ExcelTemplateSplitter</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">splitter</span><span class="o">.</span><span class="n">separate_and_export</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;files_created&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files_created&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;groups_processed&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups_processed&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;total_rows&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_rows&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processing_time&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warnings&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;failed_groups&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;failed_groups&#39;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;analysis&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="p">}</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en separación de datos: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;files_created&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;groups_processed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;total_rows&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;processing_time&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)],</span>
            <span class="s1">&#39;warnings&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;failed_groups&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Sistema de Análisis de Datos.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>